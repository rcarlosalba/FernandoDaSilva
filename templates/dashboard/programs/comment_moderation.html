{% extends 'dashboard/base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm text-gray-500">
        <a href="{% url 'dashboard:program_detail' pk=program.pk %}" class="hover:text-gray-700">{{ program.title }}</a>
        <span class="mx-2">/</span>
        <a href="{% url 'dashboard:module_detail' program_pk=program.pk pk=module.pk %}" class="hover:text-gray-700">{{ module.title }}</a>
        <span class="mx-2">/</span>
        <a href="{% url 'dashboard:session_detail' module_pk=module.pk pk=session.pk %}" class="hover:text-gray-700">{{ session.title }}</a>
        <span class="mx-2">/</span>
        <span class="text-primary-600 font-semibold">Moderar comentarios</span>
    </nav>

    <h1 class="text-2xl font-bold text-gray-900 mb-4">Moderar comentarios de la sesión</h1>
    <p class="mb-8 text-gray-600">Aquí puedes ver, responder o eliminar los comentarios de los estudiantes en esta sesión.</p>

    {% if root_comments %}
        <div class="space-y-6">
            {% for comment in root_comments %}
                <div class="bg-white shadow rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold text-gray-800">{{ comment.author.get_full_name }}</span>
                            <span class="ml-2 text-xs text-gray-400">{{ comment.created_at|date:'d M Y H:i' }}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="text-primary-600 hover:underline reply-btn" data-comment-id="{{ comment.id }}">Responder</button>
                            <button 
                                class="text-red-600 hover:text-red-900 text-sm font-medium"
                                data-delete-url="{% url 'dashboard:program_comment_delete' comment.id %}"
                                data-delete-title="Eliminar comentario"
                                data-delete-message="¿Estás seguro de que deseas eliminar el comentario '{{ comment.content|truncatewords:8 }}'?"
                            >
                                Eliminar
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 text-gray-700">{{ comment.content }}</div>
                    {% if comment.replies.all %}
                        <div class="mt-4 ml-6 border-l-2 border-gray-100 pl-4 space-y-4">
                            {% for reply in comment.replies.all %}
                                <div class="bg-gray-50 rounded p-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <span class="font-semibold text-gray-700">{{ reply.author.get_full_name }}</span>
                                            <span class="ml-2 text-xs text-gray-400">{{ reply.created_at|date:'d M Y H:i' }}</span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button class="text-primary-600 hover:underline reply-btn" data-comment-id="{{ reply.id }}">Responder</button>
                                            <button 
                                                class="text-red-600 hover:text-red-900 text-sm font-medium"
                                                data-delete-url="{% url 'dashboard:program_comment_delete' reply.id %}"
                                                data-delete-title="Eliminar comentario"
                                                data-delete-message="¿Estás seguro de que deseas eliminar el comentario '{{ reply.content|truncatewords:8 }}'?"
                                            >
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-gray-700">{{ reply.content }}</div>
                                    <div class="reply-form-container mt-4" id="reply-form-{{ reply.id }}"></div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <!-- Formulario de respuesta -->
                    <div class="reply-form-container mt-4" id="reply-form-{{ comment.id }}"></div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-12">
            <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No hay comentarios en esta sesión</h3>
            <p class="text-gray-500">Aún no se han publicado comentarios.</p>
        </div>
    {% endif %}

    <!-- Modal de eliminación (a implementar) -->
    <div id="delete-modal-placeholder"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let openForm = null;
        document.querySelectorAll('.reply-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const commentId = this.getAttribute('data-comment-id');
                // Cerrar cualquier formulario abierto
                if (openForm) {
                    openForm.innerHTML = '';
                }
                // Construir el formulario
                const formContainer = document.getElementById('reply-form-' + commentId);
                formContainer.innerHTML = `
                    <form method="POST" action="${replyUrl(commentId)}" class="space-y-2">
                        {% csrf_token %}
                        <textarea name="content" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-brand-primary transition-colors duration-200 resize-vertical min-h-[80px]" placeholder="Escribe tu respuesta..." required></textarea>
                        <div class="flex space-x-2">
                            <button type="submit" class="px-6 py-2 bg-primary-600 text-white font-medium rounded-md shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2 transition-colors duration-200">Publicar respuesta</button>
                            <button type="button" class="cancel-reply px-6 py-2 bg-gray-100 text-gray-700 font-medium rounded-md shadow-sm border border-gray-300 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200">Cancelar</button>
                        </div>
                    </form>
                `;
                openForm = formContainer;
                // Cancelar
                formContainer.querySelector('.cancel-reply').addEventListener('click', function() {
                    formContainer.innerHTML = '';
                    openForm = null;
                });
            });
        });
        function replyUrl(commentId) {
            // Construye la URL usando los datos del template
            const programPk = {{ program.pk }};
            const modulePk = {{ module.pk }};
            const sessionPk = {{ session.pk }};
            return `/dashboard/programs/${programPk}/modules/${modulePk}/sessions/${sessionPk}/comments/${commentId}/reply/`;
        }
    });
</script>
{% endblock %} 
{% include 'common/modal_delete.html' %} 